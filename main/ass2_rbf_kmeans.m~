%% initialization
clear;
close all;
clc;
load train_test_data.mat 

%% Use parallel computing
stream = RandStream('mlfg6331_64');  % Random number stream
options = statset('UseParallel',1,'UseSubstreams',1,...
    'Streams',stream);

%% Kmeans analysis to find the center location
n_cluster = 22; % the higher number of clusters, the higher performance, but overfitting would come
[idx, C] = kmeans(X_train,n_cluster,'Options',options,'MaxIter',10000,...
    'Display','final','Replicates',5);

centers = C';

%% Calculate the variance of the rbf kernel 

for i = 1:n_cluster
    dis = sqrt(sum((centers-centers(:,i)).^2)); % calculate variance for each center
    cMax = max(dis);  % select the Cmaxï¼Œthe longest distance between two centers
    var_square(i) = cMax;
end 

%% calculate the k weight matrix

X_train = X_train';
X_train_size = size(X_train);
X_train_num = X_train_size(2); % return the number of X_train (1920)

for i=1:X_train_num  
    for j=1:n_cluster 
        dis1 = sqrt(sum((X_train(:,i)-centers(:,j)).^2));
        n = dis1/(sqrt(2)*var_square(j));
        K(i,j)=radbas(n);  
    end 
end 

%% obtain the weights
y_train = y(train_idx,:);
y_test = y(test_idx,:);

weights=pinv(K'*K)*K'*y_train;

%% Return the training results
for i=1:X_train_num % calculate the simulated training output
    ww1=0; 
    for j=1:n_cluster 
        dist = sqrt(sum((X_train(:,i)-centers(:,j)).^2));
        curr2=weights(j)*exp(-dist^2/(2*var_square(j)^2)); 
        ww1=ww1 + curr2; 
    end 
    y_train_return(i) = ww1; 
end 

% obtain the training target
newtr = int64(y_train_return);

%% Calculate the testing results

X_test = X_test';
X_test_size = size(X_test);
X_test_num = X_test_size(2);

for i=1:X_test_num % calculate simulated testing output
    ww2=0; 
    for j=1:n_cluster 
        curr11=sqrt(sum((X_test(:,i)-centers(:,j)).^2));
        curr22=weights(j)*exp(-curr11^2/(2*var_square(j)^2)); 
        ww2=ww2 + curr22; 
    end 
    y_test_return(i) = ww2; 
end 
newtt = int64(y_test_return);

%%
n=1;
for i = newtt
    if i <=0 
        y_pred(:,n) = 25;
    elseif i>24
        y_pred(:,n) = 25;
    else
        y_pred(:,n) = i;
    end 
    n = n+1;
end 
%%
training_acc = rate(newtr,y_train')
testing_acc = rate(newtt, y_test')

%% plot confusio matrix
C = confusionmat(int64(y_pred'),int64(y_test));
confusionchart(C)

%% Calculate the Gaussian basis function
% n = 0;
% X_train_size = size(X_train);
% X_train_num = X_train_size(1);
% for j = 1:X_train_num
%     for i=1:n_cluster
%         dist = (X_train(j,:)'-centers(i,:)).^2;
%         rbf_up = exp(-dist);
%         rbf_down = var_square(i)*2;
%         rbf_function = rbf_up/rbf_down;
%     end 
% end 
% 
%%
% K = rbf_function;
% psedu = inv(corr);
% weights=pinv(K'*K)*K'*y_train;
%%
% tforT = y_train;
% K = rbf_function;
% corr = K'*K;
% psedu = pinv(corr)

% 
%% Train the network

%% Simulate the test value
% y_predict = sim(net,X_test);
% 
% %% transform to the vector format
% y_predict_vec = vec2ind(y_predict);
% y_test_vec = vec2ind(y_test');
% 
% %% Confusion mareix 
% C = confusionmat(y_predict_vec,y_test_vec);
% confusionchart(C)
