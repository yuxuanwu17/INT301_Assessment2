%% initialization
clear;
close all;
clc;
load train_test_data.mat 
rng(1);

%%

[ W, sigma, C ] = RBF_training( X_train, y_train, 22 );

%% Kmeans analysis to find the center location
n_cluster = 22; % the higher number of clusters, the higher performance, but overfitting would come
[idx, C] = kmeans(X_train,n_cluster);

%%
for i = 1:n_cluster
    dis = sqrt(sum((C-C(i,:)).^2)); % calculate variance for each center
    cMax = max(dis);  % select the Cmaxï¼Œthe longest distance between two centers
    var_square(i,:) = cMax;
end 


%%
    for i=1:n_cluster
        r = bsxfun(@minus, X_train, C(i,:)).^2;
        r = sum(r,2);
        k_mat(:,i) = exp((-r.^2)/(2*var_square(i)^2));
    end
%%

weights = pinv(k_mat'*k_mat)*k_mat'*y_train;

%%
n_data = size(X_test, 1);
n_center_vec = size(C, 1);
if numel(var_square) == 1
   var_square = repmat(var_square, n_center_vec, 1);
end

% kernel matrix
k_mat = zeros(n_data, n_center_vec);
for i=1:n_center_vec
    r = bsxfun(@minus, X_test, C(i,:)).^2;
    r = sum(r,2);
    k_mat(:,i) = exp((-r.^2)/(2*var_square(i)^2));
end

y = k_mat*W;

%%

%%
    
    
    
% %%
%  y = RBF_predict( X_test, W, sigma, C )
%  %%
% y_pred = vec2ind(getcls(y'))
% y_test = vec2ind(y_test')
% %% plot confusio matrix
% C = confusionmat(int64(y_pred'),int64(y_test));
% confusionchart(C)
% 
% %%
% sigma;
% W
