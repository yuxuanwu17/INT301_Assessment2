%%
clc;
clear;

%% 
F = '/Users/yuxuan/Desktop/INT301_Assessment2/ass2data'
imds = imageDatastore(F,'IncludeSubfolders',true,'LabelSource','foldernames')
%%
% figure;                              %打开figure界面
% perm = randperm(1000,20);           %从1-1000中任取20个数
% for i = 1:20
%     subplot(4,5,i);                  %将figure界面分割为4X5个小格，并选中第i个小格
%     imshow(imds.Files{perm(i)});     %在第i个小格上显示标号为i的图片
% end

%%
labelCount = countEachLabel(imds);   %统计imds中各标签值的图片数
labelCount

%%
numTrainFiles = 80;
[imdsTrain, imdsTest] = splitEachLabel(imds, numTrainFiles,'randomize');

%%
layers = [
imageInputLayer([48 24 1])           

convolution2dLayer(3,8,'Padding',1)   
batchNormalizationLayer
reluLayer
maxPooling2dLayer(2,'Stride',2)

convolution2dLayer(3,16,'Padding',1)  
batchNormalizationLayer
reluLayer
maxPooling2dLayer(2,'Stride',2)

convolution2dLayer(3,32,'Padding',1)  
batchNormalizationLayer
reluLayer

fullyConnectedLayer(10)               
softmaxLayer
classificationLayer];

%%
options = trainingOptions('sgdm','MaxEpochs',4,'ValidationData',imdsTest,'ValidationFrequency',30,'Verbose',false,'Plots','training-progress');
%%

net = trainNetwork(imdsTrain, layers, options)

%%
data = []
files = imdsTrain.Files;
x = 0
for file = files'
    im = imread(file{1});
    data = [data im];
end 
%%
X_train = reshape(data,48,24,1920);
X_train = double(X_train);
y_train = imdsTrain.Labels;
y_train = double(y_train);

%%
% imshow(X_train)
%%
data = []
files = imdsTest.Files;
x = 0
for file = files'
    im = imread(file{1});
    data = [data im];
end 
%%
X_test = reshape(data,48,24,480);
X_test = double(X_test);
y_test = imdsTest.Labels;
y_test = double(y_test);


%%
layers = [
    imageInputLayer([48 24])

    convolution2dLayer(3,8,'Padding','same')
    reluLayer
    
    averagePooling2dLayer(2,'Stride',2)

    convolution2dLayer(3,16,'Padding','same')
    reluLayer
    
    averagePooling2dLayer(2,'Stride',2)
  
    convolution2dLayer(3,32,'Padding','same')
    reluLayer
    
    convolution2dLayer(3,32,'Padding','same')
    reluLayer
    
    dropoutLayer(0.2)
    fullyConnectedLayer(1)
    regressionLayer];
%%
options = trainingOptions('sgdm', ...
    'InitialLearnRate',0.01, ...
    'MaxEpochs',10, ...
    'ValidationData',{X_test,y_test}, ...
    'ValidationFrequency',30, ...
    'Verbose',true, ...
    'Plots','training-progress');


%%


net = trainNetwork(X_train, y_train,layers, options)

% %%
%     im = imread([path file]);
%     data = [data im(:)];
% 
% %%
% files = imdsTrain.Files;
% for file = files
%     im = imread([file.name]);
%     im = double(im);
%     im = im/255;
%     data = [data im(:)];
% end
% 
% %%
